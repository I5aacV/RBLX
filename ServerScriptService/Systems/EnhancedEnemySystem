-- ========================================================================
-- FINAL REPLACEMENT - Keeps ALL Your Advanced Features
-- ServerScript in ServerScriptService/Systems/EnhancedEnemySystem
-- ========================================================================

local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Load the enhanced modules
local EnhancedBossManager = require(ReplicatedStorage.Modules.EnhancedBossManager)
local EnhancedDeathDetector = require(ReplicatedStorage.Modules.EnhancedDeathDetector)

-- Create instances
local bossManager = EnhancedBossManager.new()
local deathDetector = EnhancedDeathDetector.new()

-- Make globally accessible
_G.EnhancedBossManager = bossManager
_G.EnhancedDeathDetector = deathDetector

print("âœ… Enhanced systems loaded with ALL your features!")

-- ========================================================================
-- INTEGRATION WITH YOUR EXISTING SYSTEMS
-- ========================================================================

-- Wait for your existing EnemySpawner
spawn(function()
	local attempts = 0
	while not _G.EnemySpawner and attempts < 50 do
		task.wait(0.1)
		attempts = attempts + 1
	end

	if not _G.EnemySpawner then
		warn("âŒ EnemySpawner not found!")
		return
	end

	print("ðŸ”— Integrating with your existing EnemySpawner...")

	-- Store original functions to preserve YOUR logic
	local originalOnEnemyDied = _G.EnemySpawner.onEnemyDied
	local originalSpawnEnemy = _G.EnemySpawner.spawnEnemy
	local originalSetupEnemyDeathDetection = _G.EnemySpawner.setupEnemyDeathDetection

	-- Enhanced death handling (preserves your room clearing logic)
	_G.EnemySpawner.onEnemyDied = function(self, enemy, roomData)
		print("ðŸ’€ Enhanced death processing for:", enemy.Name)

		-- Check if it's a boss (uses YOUR boss detection + enhanced rewards)
		if bossManager:isBoss(enemy) then
			print("ðŸ‘‘ Boss detected, triggering enhanced rewards...")
			bossManager:onBossDefeated(enemy, roomData.model)
		end

		-- Call your original function to preserve room clearing logic
		originalOnEnemyDied(self, enemy, roomData)
	end

	-- Enhanced death detection setup (replaces your current method)
	_G.EnemySpawner.setupEnemyDeathDetection = function(self, enemy, roomData)
		-- Use enhanced death detector instead of original
		deathDetector:trackEnemy(enemy, function(deadEnemy, roomData)
			-- This calls our enhanced onEnemyDied which calls your original
			self:onEnemyDied(deadEnemy, roomData)
		end, roomData)

		print("âœ… Enhanced death detection setup for:", enemy.Name)
	end

	print("âœ… Integration complete - all YOUR features preserved!")
	print("ðŸ“‹ Enhanced features:")
	print("  ðŸ‘‘ Boss rewards with YOUR ItemDatabase rarity system")
	print("  ðŸ’€ Robust death detection with YOUR debug functions")
	print("  ðŸ”§ All YOUR existing room clearing logic preserved")
end)

-- ========================================================================
-- PRESERVE YOUR DEBUG COMMANDS WITH ENHANCEMENTS
-- ========================================================================

-- Enhanced version of YOUR debug commands
_G.DebugEnemies = function()
	if _G.EnemySpawner and _G.EnemySpawner.debugEnemyCounters then
		_G.EnemySpawner:debugEnemyCounters()
	end

	if deathDetector then
		deathDetector:debugTrackedEnemies()
	end
end

_G.FixEnemyCounters = function()
	if _G.EnemySpawner and _G.EnemySpawner.forceFixCounters then
		_G.EnemySpawner:forceFixCounters()
	end

	local processed = deathDetector:forceProcessDead()
	print("Enhanced fix complete! Processed", processed, "dead enemies")
end

-- Enhanced boss testing (uses YOUR ItemDatabase)
_G.TestBossRewardAdvanced = function(roomName, bossType)
	local roomModel = workspace:FindFirstChild(roomName or "BossRoom_7_5")
	if not roomModel then
		print("âŒ Room not found. Available rooms:")
		for _, obj in pairs(workspace:GetChildren()) do
			if obj:IsA("Model") and string.find(obj.Name, "Room") then
				print("  -", obj.Name)
			end
		end
		return false
	end

	-- Create realistic boss model
	local testBoss = Instance.new("Model")
	testBoss.Name = "Boss_" .. (bossType or "Monstro")

	local humanoid = Instance.new("Humanoid")
	humanoid.MaxHealth = 100
	humanoid.Health = 100
	humanoid.Parent = testBoss

	local rootPart = Instance.new("Part")
	rootPart.Name = "HumanoidRootPart"
	rootPart.Size = Vector3.new(4, 4, 4)
	rootPart.Position = Vector3.new(0, 5, 0)
	rootPart.BrickColor = BrickColor.new("Really red")
	rootPart.Anchored = true
	rootPart.Parent = testBoss

	testBoss.Parent = roomModel

	-- Trigger enhanced boss defeat
	bossManager:onBossDefeated(testBoss, roomModel)

	print("ðŸ§ª Enhanced boss reward test triggered!")
	print("ðŸ‘‘ Should spawn pedestal with item from YOUR ItemDatabase")
	print("ðŸŽ¯ Boss type:", bossType or "MONSTRO")
	return true
end

-- Replace the _G.EnhancedSystemStatus function:
_G.EnhancedSystemStatus = function()
	print("ðŸŽ¯ ENHANCED SYSTEM STATUS:")
	print("  ðŸ‘¹ EnemySpawner (yours):", _G.EnemySpawner and "âœ…" or "âŒ")
	print("  ðŸ‘‘ EnhancedBossManager:", bossManager and "âœ…" or "âŒ")
	print("  ðŸ’€ EnhancedDeathDetector:", deathDetector and "âœ…" or "âŒ")
	print("  ðŸ—ƒï¸ ItemDatabase (yours):", _G.ItemDatabase and "âœ…" or "âŒ")
	print("  ðŸ“¦ ItemSpawner (yours):", _G.ItemSpawner and "âœ…" or "âŒ")
	print("  ðŸ  RoomManager (yours):", _G.RoomManager and "âœ…" or "âŒ")

	print("\nðŸ“Š Current Stats:")

	if _G.EnemySpawner and _G.EnemySpawner.getTotalAliveEnemyCount then
		local aliveCount = _G.EnemySpawner:getTotalAliveEnemyCount()
		print("  ðŸ‘¹ Alive enemies:", aliveCount)
	end

	if deathDetector then
		print("  ðŸ’€ Tracked deaths:", deathDetector:getTrackedEnemyCount())
	end

	if bossManager then
		print("  ðŸ‘‘ Bosses defeated:", bossManager:getBossesDefeated())
	end

	if _G.ItemDatabase then
		local itemCount = 0
		for _ in pairs(_G.ItemDatabase.Items) do 
			itemCount = itemCount + 1 
		end
		print("  ðŸ—ƒï¸ Items in database:", itemCount)
	end

	return true
end

-- Replace the _G.QuickHealthCheck function:
_G.QuickHealthCheck = function()
	local aliveEnemies = 0
	if _G.EnemySpawner and _G.EnemySpawner.getTotalAliveEnemyCount then
		aliveEnemies = _G.EnemySpawner:getTotalAliveEnemyCount()
	end

	local trackedDeaths = deathDetector:getTrackedEnemyCount()

	local activeRooms = 0
	if _G.RoomManager and _G.RoomManager.getActiveRoomCount then
		activeRooms = _G.RoomManager:getActiveRoomCount()
	end

	print("âš¡ QUICK HEALTH CHECK:")
	print("  ðŸ‘¹ Alive enemies:", aliveEnemies)
	print("  ðŸ’€ Tracked deaths:", trackedDeaths)
	print("  ðŸ  Active rooms:", activeRooms)

	if aliveEnemies ~= trackedDeaths then
		warn("âš ï¸ MISMATCH: " .. aliveEnemies .. " alive vs " .. trackedDeaths .. " tracked")
		print("ðŸ’¡ Run _G.FixEnemyCounters() to repair")
		return false
	end

	print("âœ… All systems synchronized!")
	return true
end

print("ðŸš€ Enhanced system ready with ALL your features preserved!")
print("")
print("ðŸ”§ YOUR Debug Commands (Enhanced):")
print("  _G.DebugEnemies() - Your debug + enhanced tracking")
print("  _G.FixEnemyCounters() - Your counter fix + enhanced repair")
print("  _G.TestBossRewardAdvanced(roomName, bossType) - Test with YOUR ItemDatabase")
print("  _G.EnhancedSystemStatus() - Complete system overview")
print("  _G.QuickHealthCheck() - Fast synchronization check")
print("")
print("ðŸŽ¯ What's Enhanced:")
print("  âœ… Boss rewards use YOUR ItemDatabase rarity system")
print("  âœ… YOUR existing room clearing logic preserved")
print("  âœ… YOUR debug functions enhanced")
print("  âœ… YOUR asset avoidance system unchanged")
print("  âœ… ALL existing features preserved")

--[[
ðŸŽ¯ WHAT THIS PRESERVES FROM YOUR CODE:

âœ… ItemDatabase with weighted rarities
âœ… Boss-specific item pools (MONSTRO_POOL, LARRY_POOL, etc.)
âœ… Guaranteed minimum rarities
âœ… Complex rarity weighting system  
âœ… Your existing room clearing logic
âœ… Your existing asset avoidance
âœ… Your existing debug functions
âœ… Your existing door systems
âœ… Grid-based spawn point generation
âœ… Counter repair functions
âœ… Force fix capabilities
âœ… Performance tracking
âœ… All integration with ItemEffects, RoomManager, etc.

ðŸš« WHAT'S REMOVED:
âŒ Only the 800-line monolithic structure
âŒ Duplicate code that already exists in your clean modules

ðŸ“Š RESULT:
- Same functionality âœ…
- Better organization âœ…  
- Easier maintenance âœ…
- All your advanced features preserved âœ…
--]]
